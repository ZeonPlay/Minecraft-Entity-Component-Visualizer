<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Minecraft Bedrock Entity Visualizer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/json5@2.2.3/dist/index.min.js"></script>
    <style>
        :root {
            /* Warna tema */
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --accent-hover: #0098ff;
            --key-color: #9cdcfe;
            --string-color: #ce9178;
            --number-color: #b5cea8;
            --bool-color: #569cd6;
            --null-color: #888;
            --border-color: #444;
            --card-bg: #2d2d2d;
            
            /* Spasi responsif */
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 30px;
            
            /* Font responsif */
            --font-xs: 0.75rem;
            --font-sm: 0.85rem;
            --font-md: 1rem;
            --font-lg: 1.25rem;
            --font-xl: 1.5rem;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }
        
        /* Header dengan tombol bahasa dan toggle sidebar */
        #header {
            background-color: var(--sidebar-bg);
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        #mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }
        
        #mobile-menu-toggle:hover {
            color: var(--accent-color);
        }
        
        .language-switcher {
            display: flex;
            gap: 2px;
            background: #3c3c3c;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .language-btn {
            background: transparent;
            border: none;
            color: var(--text-color);
            padding: 6px 12px;
            cursor: pointer;
            font-size: var(--font-sm);
        }
        
        .language-btn:hover {
            background: #505050;
        }
        
        .language-btn.active {
            background: var(--accent-color);
            color: white;
        }
        
        /* Kontainer utama */
        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar */
        #sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-box {
            padding: 10px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            width: 100%;
            font-size: var(--font-md);
            transition: border-color 0.2s;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        #entity-list {
            overflow-y: auto;
            flex: 1;
        }
        
        .entity-item {
            padding: var(--spacing-md);
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .entity-item:hover {
            background-color: #2d2d30;
        }
        
        .entity-item.active {
            background-color: var(--accent-color);
            color: white;
        }
        
        .entity-icon {
            font-size: var(--font-lg);
            opacity: 0.7;
        }
        
        .entity-count {
            background: #3c3c3c;
            color: #aaa;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: var(--font-xs);
            margin-left: var(--spacing-sm);
        }
        
        /* Konten utama */
        #main-content {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .component-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border-left: 4px solid var(--accent-color);
        }
        
        .component-title {
            color: var(--key-color);
            font-weight: bold;
            font-size: var(--font-lg);
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-sm);
        }
        
        .json-tree {
            margin-left: 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: var(--font-sm);
            line-height: 1.5;
        }
        
        .json-line {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }
        
        .json-key {
            color: var(--key-color);
            margin-right: 8px;
        }
        
        .json-string {
            color: var(--string-color);
        }
        
        .json-number {
            color: var(--number-color);
        }
        
        .json-bool {
            color: var(--bool-color);
        }
        
        .json-null {
            color: var(--null-color);
            font-style: italic;
        }
        
        .expand-btn {
            background: transparent;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: var(--font-xs);
            padding: 0 5px;
            margin-left: 5px;
        }
        
        .expand-btn:hover {
            color: var(--accent-hover);
        }
        
        h1 {
            margin-top: 0;
            font-size: var(--font-xl);
        }
        
        .subtitle {
            color: #888;
            font-size: var(--font-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        /* Loading Status */
        #loading-status {
            font-size: var(--font-sm);
            color: #aaa;
            margin-bottom: var(--spacing-md);
            font-style: italic;
            text-align: center;
            padding: var(--spacing-md);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Message untuk tampilan awal */
        #welcome-msg {
            text-align: center;
            max-width: 600px;
            margin: auto;
            padding: var(--spacing-xl);
        }
        
        .welcome-icon {
            font-size: 4rem;
            color: var(--accent-color);
            margin-bottom: var(--spacing-lg);
            opacity: 0.8;
        }
        
        /* Responsif untuk tablet */
        @media (max-width: 1024px) {
            #sidebar {
                width: 280px;
            }
        }
        
        /* Responsif untuk ponsel */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
                transform: translateX(-100%);
            }
            
            #sidebar.active {
                transform: translateX(0);
            }
            
            #mobile-menu-toggle {
                display: block;
            }
            
            #header h1 {
                font-size: var(--font-lg);
            }
            
            .component-card {
                padding: var(--spacing-sm);
            }
            
            .json-tree {
                font-size: var(--font-xs);
            }
            
            .welcome-icon {
                font-size: 3rem;
            }
        }
        
        /* Tampilan sangat kecil */
        @media (max-width: 480px) {
            :root {
                --spacing-md: 10px;
                --spacing-lg: 15px;
                --font-md: 0.9rem;
                --font-lg: 1.1rem;
            }
            
            #main-content {
                padding: var(--spacing-sm);
            }
            
            .language-btn {
                padding: 4px 8px;
                font-size: var(--font-xs);
            }
        }
        
        /* Tampilan cetak */
        @media print {
            #header, #sidebar {
                display: none;
            }
            
            #main-content {
                overflow: visible;
            }
        }
        
        /* Scrollbar custom */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }
    </style>
</head>
<body>
    <div id="header">
        <div class="header-left">
            <button id="mobile-menu-toggle" aria-label="Toggle menu">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="app-title">Minecraft Bedrock Entity Visualizer</h1>
        </div>
        <div class="header-right">
            <div class="language-switcher">
                <button id="lang-id" class="language-btn active" onclick="changeLanguage('id')">ID</button>
                <button id="lang-en" class="language-btn" onclick="changeLanguage('en')">EN</button>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="sidebar">
            <div class="sidebar-header">
                <h3 id="sidebar-title">Daftar Entity</h3>
                <div id="loading-status">
                    <div class="loading-spinner"></div>
                    <span id="loading-text">Sedang memuat data...</span>
                </div>
                <input type="text" id="searchInput" class="search-box" placeholder="Cari entity..." aria-label="Cari entity">
                <div id="entity-count" style="font-size: 0.8em; color: #aaa; margin-top: 5px; display: none;">
                    <span id="filtered-count">0</span> / <span id="total-count">0</span> entity
                </div>
            </div>
            <div id="entity-list"></div>
        </div>

        <div id="main-content">
            <div id="welcome-msg">
                <div class="welcome-icon">
                    <i class="fas fa-dragon"></i>
                </div>
                <h1 id="welcome-title">Minecraft Bedrock Visualizer</h1>
                <p id="welcome-text">Pilih entity di sebelah kiri untuk melihat detail.</p>
                <p id="welcome-hint" style="color: #888; font-size: 0.9em; margin-top: 20px;">
                    <i class="fas fa-lightbulb"></i> Gunakan kotak pencarian untuk mencari entity dengan nama atau ID.
                </p>
            </div>
            
            <div id="details-view" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 id="entity-name">Entity Name</h1>
                    <button id="copy-json-btn" class="language-btn" style="background: var(--accent-color);">
                        <i class="fas fa-copy"></i> <span id="copy-btn-text">Salin JSON</span>
                    </button>
                </div>
                <div class="subtitle" id="entity-id">identifier: ...</div>
                
                <h3 id="desc-title">Description</h3>
                <div id="desc-container" class="component-card"></div>
                
                <h3 id="component-groups-title">Component Groups</h3>
                <div id="component-groups-container" style="margin-bottom: 20px;"></div>

                <h3 id="components-title">Components</h3>
                <div id="components-container"></div>
                
                <h3 id="events-title">Events</h3>
                <div id="events-container"></div>
                
                <div id="raw-json-container" style="display: none; margin-top: 30px;">
                    <h3 id="raw-json-title">Raw JSON</h3>
                    <pre id="raw-json" style="background: var(--card-bg); padding: 15px; border-radius: 8px; overflow: auto; max-height: 500px; font-size: 0.8em;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data dan konfigurasi
        let entitiesData = [];
        let currentLanguage = 'id';
        let currentEntityIndex = -1;
        
        // Terjemahan untuk bahasa Indonesia dan Inggris
        const translations = {
            id: {
                appTitle: "Minecraft Bedrock Entity Visualizer",
                sidebarTitle: "Daftar Entity",
                loadingText: "Sedang memuat data...",
                searchPlaceholder: "Cari entity...",
                welcomeTitle: "Minecraft Bedrock Visualizer",
                welcomeText: "Pilih entity di sebelah kiri untuk melihat detail.",
                welcomeHint: "Gunakan kotak pencarian untuk mencari entity dengan nama atau ID.",
                entityCount: "entity",
                descTitle: "Description",
                componentsGroupsTitle: "Component Group",
                componentsTitle: "Components",
                eventsTitle: "Events",
                rawJsonTitle: "Raw JSON",
                copyBtnText: "Salin JSON",
                copiedText: "JSON disalin!",
                noComponentGroups: "Tidak ada component groups.",
                noComponents: "Tidak ada komponen.",
                noEvents: "Tidak ada events."
            },
            en: {
                appTitle: "Minecraft Bedrock Entity Visualizer",
                sidebarTitle: "Entity List",
                loadingText: "Loading data...",
                searchPlaceholder: "Search entity...",
                welcomeTitle: "Minecraft Bedrock Visualizer",
                welcomeText: "Select an entity on the left to view details.",
                welcomeHint: "Use the search box to find entities by name or ID.",
                entityCount: "entities",
                descTitle: "Description",
                componentGroupsTitle: "Component Groups",
                componentsTitle: "Components",
                eventsTitle: "Events",
                rawJsonTitle: "Raw JSON",
                copyBtnText: "Copy JSON",
                copiedText: "JSON copied!",
                noComponentGroups: "No component groups.",
                noComponents: "No components.",
                noEvents: "No events."
            }
        };
        
        // Fungsi untuk mengubah bahasa
        function changeLanguage(lang) {
          try {
              currentLanguage = lang;
              
              // Update tombol bahasa aktif
              const btnId = document.getElementById('lang-id');
              const btnEn = document.getElementById('lang-en');
              
              if (btnId && btnEn) {
                  btnId.classList.remove('active');
                  btnEn.classList.remove('active');
                  
                  if (lang === 'id') {
                      btnId.classList.add('active');
                  } else {
                      btnEn.classList.add('active');
                  }
              }
              
              // Update semua teks dengan terjemahan baru
              updateUIText();
              
              // Render ulang detail entity jika ada yang aktif
              if (currentEntityIndex !== -1) {
                  showDetail(currentEntityIndex);
              }
          } catch (error) {
              console.error('Error changing language:', error);
          }
      }
        
        // Fungsi untuk memperbarui teks UI berdasarkan bahasa
        function updateUIText() {
            const t = translations[currentLanguage];
            
            // Update semua elemen dengan teks terjemahan
            document.getElementById('app-title').textContent = t.appTitle;
            document.getElementById('sidebar-title').textContent = t.sidebarTitle;
            document.getElementById('loading-text').textContent = t.loadingText;
            document.getElementById('searchInput').placeholder = t.searchPlaceholder;
            document.getElementById('welcome-title').textContent = t.welcomeTitle;
            document.getElementById('welcome-text').textContent = t.welcomeText;
            document.getElementById('welcome-hint').innerHTML = `<i class="fas fa-lightbulb"></i> ${t.welcomeHint}`;
            document.getElementById('desc-title').textContent = t.descTitle;
            document.getElementById('components-title').textContent = t.componentsTitle;
            document.getElementById('events-title').textContent = t.eventsTitle;
            document.getElementById('raw-json-title').textContent = t.rawJsonTitle;
            document.getElementById('copy-btn-text').textContent = t.copyBtnText;
            
            // Update entity count text
            const entityCountDiv = document.getElementById('entity-count');
            if (entityCountDiv.style.display !== 'none') {
                document.getElementById('entity-count').innerHTML = 
                    `<span id="filtered-count">${document.querySelectorAll('.entity-item:not([style*="display: none"])').length}</span> / ` +
                    `<span id="total-count">${entitiesData.length}</span> ${t.entityCount}`;
            }
        }
        
        // Fungsi ini jalan otomatis saat website dibuka
        window.addEventListener('DOMContentLoaded', async () => {
            // Setup event listeners
            setupEventListeners();
            
            // Setup data contoh jika server lokal tidak tersedia
            setupFallbackData();
            
            // Coba muat data dari server
            try {
                await loadAutoFiles();
            } catch (error) {
                console.error("Gagal memuat dari server:", error);
                // Gunakan data contoh
                useFallbackData();
            }
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Toggle sidebar di perangkat mobile
            document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Tutup sidebar saat klik di luar (di perangkat mobile)
            document.getElementById('main-content').addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('active');
                }
            });
            
            // Filter daftar entity saat mengetik di kotak pencarian
            document.getElementById('searchInput').addEventListener('input', filterList);
            
            // Tombol salin JSON
            document.getElementById('copy-json-btn').addEventListener('click', copyEntityJSON);
        }
        
        // Setup data contoh sebagai fallback
        function setupFallbackData() {
            // Data contoh untuk demonstrasi jika tidak ada server lokal
            window.fallbackEntities = [
                {
                    id: "minecraft:creeper",
                    name: "Creeper",
                    raw: {
                        description: {
                            identifier: "minecraft:creeper",
                            is_spawnable: true,
                            is_summonable: true,
                            is_experimental: false
                        },
                        components: {
                            "minecraft:explode": {
                                fuse_length: 1.5,
                                fuse_lit: false,
                                power: 3,
                                causes_fire: false
                            },
                            "minecraft:health": {
                                value: 20,
                                max: 20
                            }
                        },
                        events: {
                            "minecraft:entity_spawned": {
                                add: {
                                    component_groups: ["minecraft:charged_creeper"]
                                }
                            }
                        }
                    },
                    fileName: "creeper.json"
                },
                {
                    id: "minecraft:zombie",
                    name: "Zombie",
                    raw: {
                        description: {
                            identifier: "minecraft:zombie",
                            is_spawnable: true,
                            is_summonable: true,
                            is_experimental: false
                        },
                        components: {
                            "minecraft:health": {
                                value: 20,
                                max: 20
                            },
                            "minecraft:movement": {
                                value: 0.23
                            }
                        },
                        events: {}
                    },
                    fileName: "zombie.json"
                },
                {
                    id: "minecraft:skeleton",
                    name: "Skeleton",
                    raw: {
                        description: {
                            identifier: "minecraft:skeleton",
                            is_spawnable: true,
                            is_summonable: true,
                            is_experimental: false
                        },
                        components: {
                            "minecraft:health": {
                                value: 20,
                                max: 20
                            },
                            "minecraft:shooter": {
                                def: "minecraft:arrow"
                            }
                        },
                        events: {
                            "minecraft:entity_spawned": {
                                add: {
                                    component_groups: ["minecraft:skeleton_rider"]
                                }
                            }
                        }
                    },
                    fileName: "skeleton.json"
                }
            ];
        }
        
        // Gunakan data contoh jika server tidak tersedia
        function useFallbackData() {
            const statusDiv = document.getElementById('loading-status');
            entitiesData = window.fallbackEntities;
            
            // Tampilkan pesan bahwa menggunakan data contoh
            statusDiv.innerHTML = `<span style="color: #ffaa00;"><i class="fas fa-exclamation-triangle"></i> Menggunakan data contoh (${entitiesData.length} entity)</span>`;
            
            renderList();
            
            // Sembunyikan status setelah 3 detik
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        // Fungsi untuk membersihkan komentar dari JSON
function cleanJSON(jsonText) {
    // Hapus komentar satu baris (// ...)
    let cleaned = jsonText.replace(/\\"|"(?:\\"|[^"])*"|(\/\/.*)/g, 
        (match, group) => group ? "" : match);
    
    // Hapus komentar multi-baris (/* ... */)
    cleaned = cleaned.replace(/\\"|"(?:\\"|[^"])*"|(\/\*[\s\S]*?\*\/)/g,
        (match, group) => group ? "" : match);
    
    // Perbaiki trailing commas (koma sebelum } atau ])
    cleaned = cleaned.replace(/,(\s*[}\]])/g, '$1');
    
    return cleaned;
}

// Fungsi untuk mencoba memperbaiki property names yang tidak dikutip dengan benar
function fixPropertyNames(jsonText) {
    // Cari property names tanpa quotes (bukan dalam string)
    const lines = jsonText.split('\n');
    const fixedLines = lines.map(line => {
        // Pattern untuk property names tanpa quotes (yang valid di JSON5)
        // Contoh: property: value -> "property": value
        return line.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)(\s*:)/g, '$1"$2"$3');
    });
    
    return fixedLines.join('\n');
}

// Fungsi untuk mencoba parse JSON dengan beberapa metode
function safeJSONParse(text, fileName) {
    try {
        // Coba parse langsung
        return JSON.parse(text);
    } catch (firstError) {
        console.log(`Gagal parse langsung ${fileName}, mencoba bersihkan komentar...`);
        
        try {
            // Bersihkan komentar dan coba lagi
            const cleaned = cleanJSON(text);
            return JSON.parse(cleaned);
        } catch (secondError) {
            console.log(`Gagal dengan cleanJSON ${fileName}, mencoba fixPropertyNames...`);
            
            try {
                // Coba perbaiki property names (JSON5 style)
                const fixed = fixPropertyNames(text);
                const cleaned = cleanJSON(fixed);
                return JSON.parse(cleaned);
            } catch (thirdError) {
                console.log(`Semua metode gagal untuk ${fileName}, error:`, thirdError.message);
                
                // Log error untuk debugging
                console.error(`File ${fileName} menyebabkan error:`, thirdError.message);
                
                // Untuk debugging, tampilkan potongan yang bermasalah
                const lines = text.split('\n');
                const errorLine = thirdError.message.match(/line (\d+)/);
                if (errorLine) {
                    const lineNum = parseInt(errorLine[1]) - 1;
                    const start = Math.max(0, lineNum - 2);
                    const end = Math.min(lines.length, lineNum + 3);
                    console.log("Potongan kode bermasalah:", lines.slice(start, end).join('\n'));
                }
                
                throw thirdError;
            }
        }
    }
}

async function loadAutoFiles() {
    const statusDiv = document.getElementById('loading-status');
    const DATA_FOLDER = './data/';
    const LIST_FILE = 'list.json';
    
    try {
        // 1. Ambil daftar file (list.json)
        statusDiv.innerHTML = `<div class="loading-spinner"></div><span id="loading-text">${translations[currentLanguage].loadingText} (memuat daftar...)</span>`;
        
        const response = await fetch(LIST_FILE);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: Gagal memuat list.json`);
        }
        
        const fileList = await response.json();
        
        // Update status dengan progress bar visual
        statusDiv.innerHTML = `
            <div class="loading-spinner"></div>
            <span id="loading-text">${translations[currentLanguage].loadingText}</span>
            <div style="margin-top: 10px; width: 100%; background: #333; border-radius: 5px; overflow: hidden;">
                <div id="progress-bar" style="width: 0%; height: 4px; background: var(--accent-color); transition: width 0.3s;"></div>
            </div>
            <div style="font-size: 0.8em; margin-top: 5px; color: #aaa;">
                <span id="progress-text">0/${fileList.length}</span>
            </div>
        `;
        
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        // 2. Load file dengan rate limiting (batch processing)
        entitiesData = [];
        const failedFiles = [];
        const partiallyFixedFiles = [];
        
        // Process in batches of 5 files at a time (lebih kecil untuk debugging)
        const batchSize = 5;
        for (let i = 0; i < fileList.length; i += batchSize) {
            const batch = fileList.slice(i, i + batchSize);
            const batchPromises = batch.map(async (fileName, index) => {
                try {
                    // Timeout untuk mencegah hanging request
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 detik timeout
                    
                    const fileResponse = await fetch(DATA_FOLDER + fileName, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!fileResponse.ok) {
                        throw new Error(`HTTP ${fileResponse.status} untuk ${fileName}`);
                    }
                    
                    const text = await fileResponse.text();
                    
                    // Validasi file tidak kosong
                    if (!text.trim()) {
                        throw new Error(`File ${fileName} kosong`);
                    }
                    
                    let json;
                    let isFixed = false;
                    
                    try {
                        // Coba parse dengan metode aman
                        json = safeJSONParse(text, fileName);
                    } catch (parseError) {
                        console.warn(`Metode parsing gagal untuk ${fileName}, mencoba perbaikan manual...`);
                        
                        // Coba perbaikan manual yang lebih agresif
                        let fixedText = text;
                        
                        // 1. Hapus semua komentar (agresif)
                        fixedText = fixedText.replace(/\s*\/\/.*$/gm, '');
                        fixedText = fixedText.replace(/\/\*[\s\S]*?\*\//g, '');
                        
                        // 2. Perbaiki trailing commas
                        fixedText = fixedText.replace(/,\s*([}\]])/g, '$1');
                        
                        // 3. Tambahkan quotes pada property names yang tidak punya
                        fixedText = fixedText.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)(\s*:)/g, '$1"$2"$3');
                        
                        // 4. Perbaiki array dengan koma yang salah
                        fixedText = fixedText.replace(/,\s*]/g, ']');
                        
                        try {
                            json = JSON.parse(fixedText);
                            isFixed = true;
                            console.log(`File ${fileName} berhasil diperbaiki secara manual`);
                            partiallyFixedFiles.push(fileName);
                        } catch (finalError) {
                            // Untuk debugging lebih lanjut, simpan file yang bermasalah
                            console.error(`File ${fileName} tidak bisa diperbaiki:`, finalError.message);
                            throw new Error(`JSON tidak valid setelah perbaikan: ${finalError.message}`);
                        }
                    }
                    
                    // Validasi struktur entity
                    if (!json || !json["minecraft:entity"]) {
                        console.warn(`File ${fileName} bukan file entity yang valid`);
                        // Tapi kita tetap coba proses
                        if (!json) json = {};
                        if (!json["minecraft:entity"]) {
                            json["minecraft:entity"] = {
                                description: {
                                    identifier: fileName.replace('.json', ''),
                                    note: "File tidak memiliki struktur minecraft:entity yang valid"
                                },
                                components: {},
                                events: {}
                            };
                        }
                    }
                    
                    const entityNode = json["minecraft:entity"];
                    
                    // Pastikan ada description dan identifier
                    if (!entityNode.description) {
                        entityNode.description = { 
                            identifier: fileName.replace('.json', ''),
                            note: "File tidak memiliki description"
                        };
                    }
                    
                    const identifier = entityNode.description.identifier || fileName.replace('.json', '');
                    const shortName = identifier.replace("minecraft:", "").replace(/_/g, " ");
                    
                    return {
                        id: identifier,
                        name: capitalizeWords(shortName),
                        raw: entityNode,
                        fileName: fileName,
                        isFixed: isFixed,
                        isFallback: false
                    };
                } catch (error) {
                    console.warn(`Gagal memuat ${fileName}:`, error.message);
                    failedFiles.push({ 
                        fileName, 
                        error: error.message,
                        isCommentError: error.message.includes('comment') || 
                                       error.message.includes('//') || 
                                       error.message.includes('/*')
                    });
                    
                    // Return fallback data untuk file yang gagal
                    const entityId = fileName.replace('.json', '');
                    return {
                        id: entityId,
                        name: capitalizeWords(entityId.replace(/_/g, " ")),
                        raw: {
                            description: {
                                identifier: entityId,
                                is_spawnable: true,
                                is_summonable: true,
                                is_experimental: false,
                                note: `File asli gagal dimuat: ${error.message}`
                            },
                            components: {
                                "minecraft:health": {
                                    value: 20,
                                    max: 20,
                                    note: "Data fallback karena file JSON bermasalah"
                                }
                            },
                            events: {}
                        },
                        fileName: fileName,
                        isFallback: true
                    };
                }
            });
            
            // Tunggu batch selesai
            const batchResults = await Promise.allSettled(batchPromises);
            
            // Tambahkan yang berhasil
            batchResults.forEach(result => {
                if (result.status === 'fulfilled' && result.value) {
                    entitiesData.push(result.value);
                }
            });
            
            // Update progress
            const processed = Math.min(i + batchSize, fileList.length);
            const progressPercent = (processed / fileList.length) * 100;
            
            if (progressBar) {
                progressBar.style.width = `${progressPercent}%`;
            }
            
            if (progressText) {
                progressText.textContent = `${processed}/${fileList.length}`;
            }
            
            // Beri sedikit delay antar batch
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        // Filter duplikat berdasarkan ID
        const uniqueEntities = [];
        const seenIds = new Set();
        
        entitiesData.forEach(entity => {
            if (!seenIds.has(entity.id)) {
                seenIds.add(entity.id);
                uniqueEntities.push(entity);
            }
        });
        
        entitiesData = uniqueEntities;
        
        // Tampilkan status akhir dengan info file yang gagal
        let statusHTML = `<span style="color: #4caf50;"><i class="fas fa-check-circle"></i> Data siap! (${entitiesData.length} entity berhasil dimuat)</span>`;
        
        if (failedFiles.length > 0) {
            statusHTML += `<br><span style="color: #ff9800; font-size: 0.9em;">
                <i class="fas fa-exclamation-triangle"></i> ${failedFiles.length} file gagal dimuat (masih ditampilkan dengan data fallback)
            </span>`;
            
            // Pisahkan file yang gagal karena komentar
            const commentErrors = failedFiles.filter(f => f.isCommentError);
            if (commentErrors.length > 0) {
                statusHTML += `<br><span style="color: #ff5722; font-size: 0.8em;">
                    <i class="fas fa-code"></i> ${commentErrors.length} file mengandung komentar JSON yang tidak valid
                </span>`;
            }
        }
        
        if (partiallyFixedFiles.length > 0) {
            statusHTML += `<br><span style="color: #2196f3; font-size: 0.9em;">
                <i class="fas fa-wrench"></i> ${partiallyFixedFiles.length} file diperbaiki otomatis (mengandung komentar/trailing commas)
            </span>`;
        }
        
        // Tampilkan peringatan jika menggunakan data fallback
        const fallbackCount = entitiesData.filter(e => e.isFallback).length;
        if (fallbackCount > 0) {
            statusHTML += `<br><span style="color: #9c27b0; font-size: 0.9em;">
                <i class="fas fa-info-circle"></i> ${fallbackCount} entity menggunakan data fallback
            </span>`;
        }
        
        // Tampilkan tombol untuk melihat detail error
        if (failedFiles.length > 0 || partiallyFixedFiles.length > 0) {
            statusHTML += `<br><button id="show-errors-btn" style="margin-top: 10px; padding: 5px 10px; background: #333; border: 1px solid #555; color: #aaa; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
                <i class="fas fa-bug"></i> Tampilkan Detail Masalah
            </button>`;
        }
        
        statusDiv.innerHTML = statusHTML;
        
        // Tambahkan event listener untuk tombol detail error
        const showErrorsBtn = document.getElementById('show-errors-btn');
        if (showErrorsBtn) {
            showErrorsBtn.addEventListener('click', () => {
                alert(`File yang diperbaiki otomatis (${partiallyFixedFiles.length}):\n${partiallyFixedFiles.join(', ')}\n\n` +
                      `File yang menggunakan fallback (${failedFiles.length}):\n${failedFiles.map(f => f.fileName).join(', ')}`);
            });
        }
        
        renderList();
        
        // Sembunyikan status setelah 5 detik
        setTimeout(() => {
            statusDiv.style.opacity = '0.7';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 1000);
        }, 5000);
        
    } catch (error) {
        console.error("Kesalahan utama dalam loadAutoFiles:", error);
        statusDiv.innerHTML = `<span style="color: #f44336;">
            <i class="fas fa-exclamation-circle"></i> Error: ${error.message}
        </span>`;
        
        // Fallback ke data contoh setelah 2 detik
        setTimeout(() => {
            useFallbackData();
        }, 2000);
    }
}

// Perbaiki juga fungsi capitalizeWords untuk handle error
function capitalizeWords(str) {
    if (!str || typeof str !== 'string') return 'Unknown Entity';
    return str
        .replace(/\b\w/g, l => l.toUpperCase())
        .replace(/\bmc\b/gi, 'MC')
        .replace(/\bid\b/gi, 'ID');
}

        function capitalizeWords(str) {
            return str.replace(/\b\w/g, l => l.toUpperCase());
        }

        function renderList() {
            // Urutkan berdasarkan nama
            entitiesData.sort((a, b) => a.name.localeCompare(b.name));
            const listContainer = document.getElementById('entity-list');
            listContainer.innerHTML = '';
            
            // Tampilkan jumlah entity
            const entityCountDiv = document.getElementById('entity-count');
            entityCountDiv.style.display = 'block';
            entityCountDiv.innerHTML = `<span id="filtered-count">${entitiesData.length}</span> / <span id="total-count">${entitiesData.length}</span> ${translations[currentLanguage].entityCount}`;

            entitiesData.forEach((entity, index) => {
                const div = document.createElement('div');
                div.className = 'entity-item';
                div.setAttribute('data-index', index);
                div.setAttribute('data-name', entity.name.toLowerCase());
                div.setAttribute('data-id', entity.id.toLowerCase());
                
                // Tentukan ikon berdasarkan nama entity
                let icon = 'fas fa-question';
                if (entity.name.toLowerCase().includes('creeper')) icon = 'fas fa-bomb';
                else if (entity.name.toLowerCase().includes('zombie')) icon = 'fas fa-brain';
                else if (entity.name.toLowerCase().includes('skeleton')) icon = 'fas fa-bone';
                else if (entity.name.toLowerCase().includes('spider')) icon = 'fas fa-spider';
                else if (entity.name.toLowerCase().includes('ender')) icon = 'fas fa-eye';
                else if (entity.name.toLowerCase().includes('villager')) icon = 'fas fa-user';
                else if (entity.name.toLowerCase().includes('animal')) icon = 'fas fa-paw';
                else if (entity.name.toLowerCase().includes('fish')) icon = 'fas fa-fish';
                else if (entity.name.toLowerCase().includes('bird')) icon = 'fas fa-dove';
                
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="${icon} entity-icon"></i>
                        <div>
                            <div><b>${entity.name}</b></div>
                            <div style="font-size: 0.8em; color: #888;">${entity.id}</div>
                        </div>
                    </div>
                    <div class="entity-count">${Object.keys(entity.raw.components || {}).length}</div>
                `;
                div.onclick = () => {
                    // Set semua item sebagai tidak aktif
                    document.querySelectorAll('.entity-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    // Set item yang diklik sebagai aktif
                    div.classList.add('active');
                    // Tampilkan detail
                    showDetail(index);
                    
                    // Di perangkat mobile, tutup sidebar setelah memilih
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                };
                listContainer.appendChild(div);
            });
        }

        function filterList() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const items = document.getElementsByClassName('entity-item');
            let visibleCount = 0;
            
            Array.from(items).forEach(item => {
                const name = item.getAttribute('data-name');
                const id = item.getAttribute('data-id');
                const matches = name.includes(query) || id.includes(query);
                item.style.display = matches ? 'flex' : 'none';
                if (matches) visibleCount++;
            });
            
            // Update jumlah entity yang difilter
            document.getElementById('filtered-count').textContent = visibleCount;
        }

        function showDetail(index) {
    currentEntityIndex = index;
    const data = entitiesData[index];
    const raw = data.raw;

    document.getElementById('welcome-msg').style.display = 'none';
    document.getElementById('details-view').style.display = 'block';
    document.getElementById('entity-name').innerText = data.name;
    document.getElementById('entity-id').innerText = `identifier: ${data.id}`;

    // Render Description
    document.getElementById('desc-container').innerHTML = renderJSON(raw.description, 0);

    // Render Component Groups
    const compGroupContainer = document.getElementById('component-groups-container');
    compGroupContainer.innerHTML = '';
    if (raw.component_groups && Object.keys(raw.component_groups).length > 0) {
        Object.keys(raw.component_groups).forEach(key => {
            const card = document.createElement('div');
            card.className = 'component-card';
            card.innerHTML = `<div class="component-title">${key}</div>`;
            card.innerHTML += renderJSON(raw.component_groups[key], 0);
            compGroupContainer.appendChild(card);
        });
    } else {
        compGroupContainer.innerHTML = `<p style="color:#777">${translations[currentLanguage].noComponentGroups || 'No component groups.'}</p>`;
    }

    // Render Components
    const compContainer = document.getElementById('components-container');
    compContainer.innerHTML = '';
    if (raw.components && Object.keys(raw.components).length > 0) {
        Object.keys(raw.components).forEach(key => {
            const cleanTitle = key.replace("minecraft:", "");
            const card = document.createElement('div');
            card.className = 'component-card';
            card.innerHTML = `<div class="component-title">${cleanTitle}</div>`;
            card.innerHTML += renderJSON(raw.components[key], 0);
            compContainer.appendChild(card);
        });
    } else {
        compContainer.innerHTML = `<p style="color:#777">${translations[currentLanguage].noComponents}</p>`;
    }

    // Render Events
    const eventContainer = document.getElementById('events-container');
    eventContainer.innerHTML = '';
    if (raw.events && Object.keys(raw.events).length > 0) {
        Object.keys(raw.events).forEach(key => {
            const card = document.createElement('div');
            card.className = 'component-card';
            card.innerHTML = `<div class="component-title">${key}</div>`;
            card.innerHTML += renderJSON(raw.events[key], 0);
            eventContainer.appendChild(card);
        });
    } else {
        eventContainer.innerHTML = `<p style="color:#777">${translations[currentLanguage].noEvents}</p>`;
    }
    
    // Tampilkan raw JSON
    document.getElementById('raw-json-container').style.display = 'block';
    document.getElementById('raw-json').textContent = JSON.stringify(raw, null, 2);
}

        function renderJSON(obj, depth) {
            if (typeof obj !== 'object' || obj === null) {
                let colorClass = 'json-string';
                let displayValue = obj;
                
                if (typeof obj === 'number') colorClass = 'json-number';
                if (typeof obj === 'boolean') colorClass = 'json-bool';
                if (obj === null) {
                    colorClass = 'json-null';
                    displayValue = 'null';
                }
                if (typeof obj === 'string') displayValue = `"${obj}"`;
                
                return `<span class="${colorClass}">${displayValue}</span>`;
            }
            
            const isArray = Array.isArray(obj);
            let html = '<div class="json-tree">';
            
            if (isArray && obj.length === 0) {
                html += `<span class="json-null">[]</span>`;
            } else if (!isArray && Object.keys(obj).length === 0) {
                html += `<span class="json-null">{}</span>`;
            } else {
                const keys = isArray ? obj.map((_, i) => i) : Object.keys(obj);
                
                keys.forEach(key => {
                    html += `<div class="json-line">`;
                    if (!isArray) {
                        html += `<span class="json-key">"${key}":</span> `;
                    }
                    html += renderJSON(obj[key], depth + 1);
                    html += `</div>`;
                });
            }
            
            html += '</div>';
            return html;
        }
        
        // Fungsi untuk menyalin JSON entity ke clipboard
        function copyEntityJSON() {
            if (currentEntityIndex === -1) return;
            
            const entity = entitiesData[currentEntityIndex];
            const jsonStr = JSON.stringify(entity.raw, null, 2);
            
            // Gunakan Clipboard API jika tersedia
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(jsonStr).then(() => {
                    showCopyFeedback();
                });
            } else {
                // Fallback untuk browser lama
                const textArea = document.createElement('textarea');
                textArea.value = jsonStr;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyFeedback();
            }
        }
        
        // Tampilkan feedback saat JSON disalin
        function showCopyFeedback() {
            const btn = document.getElementById('copy-json-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = `<i class="fas fa-check"></i> ${translations[currentLanguage].copiedText}`;
            btn.style.background = '#4caf50';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = 'var(--accent-color)';
            }, 2000);
        }
        
        // Handle resize window untuk responsif
        window.addEventListener('resize', function() {
            // Di perangkat besar, pastikan sidebar terlihat
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        });
    </script>
</body>
</html>